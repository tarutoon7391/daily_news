name: Daily AI News

on:
  schedule:
    - cron: "0 22 * * *"  # JST 7:00
  workflow_dispatch:

jobs:
  news:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq libxml2-utils

      # --- Fetch RSS ---

      - name: Fetch ITmedia AI+ Top 5 News
        run: |
          HTTP_CODE=$(curl -s -o it_raw.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://rss.itmedia.co.jp/rss/2.0/aiplus.xml)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "ITmedia AI+ RSSã®å–å¾—ã«å¤±æ•—ï¼ˆHTTP $HTTP_CODEï¼‰ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            for i in 1 2 3 4 5; do
              echo "IT${i}_INPUT=ITmedia AI+è¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            done
            exit 0
          fi

          DETECTED=$(file -bi it_raw.xml | grep -oP 'charset=\K[^ ;]+' || echo "utf-8")
          if [ "$DETECTED" != "utf-8" ] && [ "$DETECTED" != "us-ascii" ]; then
            iconv -f "$DETECTED" -t UTF-8 it_raw.xml > it.xml
          else
            mv it_raw.xml it.xml
          fi

          if ! xmllint --noout it.xml 2>/dev/null; then
            echo "ITmedia AI+ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœ‰åŠ¹ãªXMLã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            for i in 1 2 3 4 5; do
              echo "IT${i}_INPUT=ITmedia AI+è¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            done
            exit 0
          fi

          for i in 1 2 3 4 5; do
            TITLE=$(xmllint --xpath "string(//item[$i]/title)" it.xml 2>/dev/null || echo "")
            DESC=$(xmllint --xpath "string(//item[$i]/description)" it.xml 2>/dev/null || echo "")
            if [ -z "$TITLE" ]; then
              echo "IT${i}_INPUT=ITmedia AI+è¨˜äº‹${i}ä»¶ç›®ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            else
              echo "IT${i}_INPUT<<EOF" >> $GITHUB_ENV
              echo "ã€${TITLE}ã€‘${DESC}" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          done

      # --- AI Summary ---

      - name: Summarize with AI
        env:
          API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          summarize() {
            jq -n --arg content "$1" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¦‚è¦ã‹ã‚‰ã€ä½•ãŒèµ·ããŸã‹ãƒ»ãªãœé‡è¦ã‹ã‚’å…·ä½“çš„ã«2è¡Œã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚å›ºæœ‰åè©ã‚„æ•°å­—ã¯çœç•¥ã—ãªã„ã§ãã ã•ã„ã€‚"},
                {role: "user", content: $content}
              ]
            }' | curl -s https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d @- | jq -r '.choices[0].message.content'
          }

          for i in 1 2 3 4 5; do
            eval "INPUT=\"[27m$IT${i}_INPUT[0m\""
            SUMMARY=$(summarize "$INPUT")
            echo "IT${i}_SUMMARY<<EOF" >> $GITHUB_ENV
            echo "$SUMMARY" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          done

      # --- Send to Discord ---

      - name: Send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CONTENT=$(printf 'ğŸ“° **ä»Šæ—¥ã®ITãƒ»AIãƒ‹ãƒ¥ãƒ¼ã‚¹ TOP5**\n\nğŸ’» **ã€ITâ‘ ã€‘**\n%s\n\nğŸ’» **ã€ITâ‘¡ã€‘**\n%s\n\nğŸ’» **ã€ITâ‘¢ã€‘**\n%s\n\nğŸ’» **ã€ITâ‘£ã€‘**\n%s\n\nğŸ’» **ã€ITâ‘¤ã€‘**\n%s' "$IT1_SUMMARY" "$IT2_SUMMARY" "$IT3_SUMMARY" "$IT4_SUMMARY" "$IT5_SUMMARY")

          jq -n --arg content "$CONTENT" '{content: $content}' | curl -s \
            -H "Content-Type: application/json" \
            -X POST \
            -d @- \
            "$WEBHOOK"