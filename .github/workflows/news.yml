name: Daily AI News

on:
  schedule:
    - cron: "0 22 * * *"  # JST 7:00
  workflow_dispatch:

jobs:
  news:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq xmlstarlet libxml2-utils

      # --- Fetch RSS ---

      - name: Fetch NHK Top News
        run: |
          HTTP_CODE=$(curl -s -o nhk.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://www3.nhk.or.jp/rss/news/cat0.xml)

          if [ "$HTTP_CODE" -ne 200 ] || ! xmllint --noout nhk.xml 2>/dev/null; then
            echo "NHK RSS„ÅÆÂèñÂæó„Å´Â§±Êïó„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô..."
            echo "NHK_DESC=NHKË®ò‰∫ã„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü" >> $GITHUB_ENV
            exit 0
          fi

          NHK_DESC=$(xmllint --xpath "string(//item[1]/description)" nhk.xml)
          echo "NHK_DESC<<EOF" >> $GITHUB_ENV
          echo "$NHK_DESC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch ITmedia News
        run: |
          HTTP_CODE=$(curl -s -o it_raw.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://rss.itmedia.co.jp/rss/2.0/news_bursts.xml)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "ITmedia RSS„ÅÆÂèñÂæó„Å´Â§±ÊïóÔºàHTTP $HTTP_CODEÔºâ„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô..."
            echo "IT_DESC=ITmediaË®ò‰∫ã„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü" >> $GITHUB_ENV
            exit 0
          fi

          DETECTED=$(file -bi it_raw.xml | grep -oP 'charset=\K[^ ;]+' || echo "utf-8")
          if [ "$DETECTED" != "utf-8" ] && [ "$DETECTED" != "us-ascii" ]; then
            iconv -f "$DETECTED" -t UTF-8 it_raw.xml > it.xml
          else
            mv it_raw.xml it.xml
          fi

          if ! xmllint --noout it.xml 2>/dev/null; then
            echo "ITmedia„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„ÅåÊúâÂäπ„Å™XML„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô..."
            echo "IT_DESC=ITmediaË®ò‰∫ã„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü" >> $GITHUB_ENV
            exit 0
          fi

          IT_DESC=$(xmllint --xpath "string(//item[1]/description)" it.xml)
          echo "IT_DESC<<EOF" >> $GITHUB_ENV
          echo "$IT_DESC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch Gigazine Tech
        run: |
          HTTP_CODE=$(curl -s -o giga_raw.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://gigazine.net/news/rss_2.0/)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Gigazine RSS„ÅÆÂèñÂæó„Å´Â§±ÊïóÔºàHTTP $HTTP_CODEÔºâ„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô..."
            echo "GIGA_DESC=GigazineË®ò‰∫ã„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü" >> $GITHUB_ENV
            exit 0
          fi

          DETECTED=$(file -bi giga_raw.xml | grep -oP 'charset=\K[^ ;]+' || echo "utf-8")
          if [ "$DETECTED" != "utf-8" ] && [ "$DETECTED" != "us-ascii" ]; then
            iconv -f "$DETECTED" -t UTF-8 giga_raw.xml > giga.xml
          else
            mv giga_raw.xml giga.xml
          fi

          if ! xmllint --noout giga.xml 2>/dev/null; then
            echo "Gigazine„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„ÅåÊúâÂäπ„Å™XML„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô..."
            echo "GIGA_DESC=GigazineË®ò‰∫ã„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü" >> $GITHUB_ENV
            exit 0
          fi

          GIGA_DESC=$(xmllint --xpath "string(//item[1]/description)" giga.xml)
          echo "GIGA_DESC<<EOF" >> $GITHUB_ENV
          echo "$GIGA_DESC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- AI Summary ---

      - name: Summarize with AI
        env:
          API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          summarize() {
            jq -n --arg content "$1" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "„Éã„É•„Éº„Çπ„Çí2Ë°å„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"},
                {role: "user", content: $content}
              ]
            }' | curl -s https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d @- | jq -r '.choices[0].message.content'
          }

          NHK_SUMMARY=$(summarize "$NHK_DESC")
          IT_SUMMARY=$(summarize "$IT_DESC")
          GIGA_SUMMARY=$(summarize "$GIGA_DESC")

          echo "NHK_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$NHK_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "IT_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$IT_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "GIGA_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$GIGA_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- Send to Discord ---

      - name: Send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CONTENT=$(printf 'üì∞ **‰ªäÊó•„ÅÆAIË¶ÅÁ¥Ñ„Éã„É•„Éº„Çπ**\n\n**„ÄêÊúÄÈáçË¶Å„Éã„É•„Éº„Çπ„Äë**\n%s\n\n**„ÄêIT„Éã„É•„Éº„Çπ„Äë**\n%s\n\n**„ÄêAI„ÉªÈù¢ÁôΩ„ÉÜ„ÉÉ„ÇØ„Äë**\n%s' "$NHK_SUMMARY" "$IT_SUMMARY" "$GIGA_SUMMARY")

          jq -n --arg content "$CONTENT" '{content: $content}' | curl -s \
            -H "Content-Type: application/json" \
            -X POST \
            -d @- \
            "$WEBHOOK"