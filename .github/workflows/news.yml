name: Daily AI News

on:
  schedule:
    - cron: "0 22 * * *"  # JST 7:00
  workflow_dispatch:

jobs:
  news:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq xmlstarlet

      # --- Fetch RSS ---

      - name: Fetch NHK Top News
        run: |
          curl -s https://www3.nhk.or.jp/rss/news/cat0.xml -o nhk.xml
          NHK_DESC=$(xmllint --xpath "string(//item[1]/description)" nhk.xml)
          echo "NHK_DESC=$NHK_DESC" >> $GITHUB_ENV

      - name: Fetch ITmedia News
        run: |
          curl -s https://www.itmedia.co.jp/news/subtop/rss2/0.xml -o it.xml
          IT_DESC=$(xmllint --xpath "string(//item[1]/description)" it.xml)
          echo "IT_DESC=$IT_DESC" >> $GITHUB_ENV

      - name: Fetch Gigazine Tech
        run: |
          curl -s https://gigazine.net/news/rss_2.0/ -o giga.xml
          GIGA_DESC=$(xmllint --xpath "string(//item[1]/description)" giga.xml)
          echo "GIGA_DESC=$GIGA_DESC" >> $GITHUB_ENV
# --- AI Summary ---

      - name: Summarize with AI
        env:
          API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          summarize() {
            curl -s https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d "{
                \"model\": \"gpt-4o-mini\",
                \"messages\": [
                  {\"role\": \"system\", \"content\": \"ニュースを2行で要約してください。\"},
                  {\"role\": \"user\", \"content\": \"$1\"}
                ]
              }" | jq -r '.choices[0].message.content'
          }

          NHK_SUMMARY=$(summarize "$NHK_DESC")
          IT_SUMMARY=$(summarize "$IT_DESC")
          GIGA_SUMMARY=$(summarize "$GIGA_DESC")

          echo "NHK_SUMMARY=$NHK_SUMMARY" >> $GITHUB_ENV
          echo "IT_SUMMARY=$IT_SUMMARY" >> $GITHUB_ENV
          echo "GIGA_SUMMARY=$GIGA_SUMMARY" >> $GITHUB_ENV

      # --- Send to Discord ---

      - name: Send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CONTENT="📰 **今日のAI要約ニュース**\n\n\
**【最重要ニュース】**\n$NHK_SUMMARY\n\n\
**【ITニュース】**\n$IT_SUMMARY\n\n\
**【AI・面白テック】**\n$GIGA_SUMMARY"

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\":\"${CONTENT//\"/\\\"}\"}" \
            "$WEBHOOK"
          
