name: Daily AI News

on:
  schedule:
    - cron: "0 22 * * *"  # JST 7:00
  workflow_dispatch:

jobs:
  news:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq libxml2-utils

      # --- Fetch RSS ---

      - name: Fetch NHK Top News
        run: |
          HTTP_CODE=$(curl -s -o nhk.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://www3.nhk.or.jp/rss/news/cat0.xml)

          if [ "$HTTP_CODE" -ne 200 ] || ! xmllint --noout nhk.xml 2>/dev/null; then
            echo "NHK RSSã®å–å¾—ã«å¤±æ•—ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            echo "NHK_INPUT=NHKè¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            exit 0
          fi

          NHK_TITLE=$(xmllint --xpath "string(//item[1]/title)" nhk.xml)
          NHK_DESC=$(xmllint --xpath "string(//item[1]/description)" nhk.xml)
          echo "NHK_INPUT<<EOF" >> $GITHUB_ENV
          echo "ã€${NHK_TITLE}ã€‘${NHK_DESC}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch ITmedia AI+ News
        run: |
          HTTP_CODE=$(curl -s -o it_raw.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://rss.itmedia.co.jp/rss/2.0/aiplus.xml)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "ITmedia AI+ RSSã®å–å¾—ã«å¤±æ•—ï¼ˆHTTP $HTTP_CODEï¼‰ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            echo "IT_INPUT=ITmedia AI+è¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            exit 0
          fi

          DETECTED=$(file -bi it_raw.xml | grep -oP 'charset=\K[^ ;]+' || echo "utf-8")
          if [ "$DETECTED" != "utf-8" ] && [ "$DETECTED" != "us-ascii" ]; then
            iconv -f "$DETECTED" -t UTF-8 it_raw.xml > it.xml
          else
            mv it_raw.xml it.xml
          fi

          if ! xmllint --noout it.xml 2>/dev/null; then
            echo "ITmedia AI+ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœ‰åŠ¹ãªXMLã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            echo "IT_INPUT=ITmedia AI+è¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            exit 0
          fi

          IT_TITLE=$(xmllint --xpath "string(//item[1]/title)" it.xml)
          IT_DESC=$(xmllint --xpath "string(//item[1]/description)" it.xml)
          echo "IT_INPUT<<EOF" >> $GITHUB_ENV
          echo "ã€${IT_TITLE}ã€‘${IT_DESC}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch ITmedia Buzz News
        run: |
          HTTP_CODE=$(curl -s -o buzz_raw.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://rss.itmedia.co.jp/rss/2.0/news_bursts.xml)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "ITmedia ãƒã‚ºãƒ‹ãƒ¥ãƒ¼ã‚¹RSSã®å–å¾—ã«å¤±æ•—ï¼ˆHTTP $HTTP_CODEï¼‰ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            echo "BUZZ_INPUT=ITmediaãƒã‚ºãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            exit 0
          fi

          DETECTED=$(file -bi buzz_raw.xml | grep -oP 'charset=\K[^ ;]+' || echo "utf-8")
          if [ "$DETECTED" != "utf-8" ] && [ "$DETECTED" != "us-ascii" ]; then
            iconv -f "$DETECTED" -t UTF-8 buzz_raw.xml > buzz.xml
          else
            mv buzz_raw.xml buzz.xml
          fi

          if ! xmllint --noout buzz.xml 2>/dev/null; then
            echo "ITmediaãƒã‚ºãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœ‰åŠ¹ãªXMLã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            echo "BUZZ_INPUT=ITmediaãƒã‚ºãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            exit 0
          fi

          BUZZ_TITLE=$(xmllint --xpath "string(//item[1]/title)" buzz.xml)
          BUZZ_DESC=$(xmllint --xpath "string(//item[1]/description)" buzz.xml)
          echo "BUZZ_INPUT<<EOF" >> $GITHUB_ENV
          echo "ã€${BUZZ_TITLE}ã€‘${BUZZ_DESC}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- AI Summary ---

      - name: Summarize with AI
        env:
          API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          summarize() {
            jq -n --arg content "$1" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¦‚è¦ã‹ã‚‰ã€ä½•ãŒèµ·ããŸã‹ãƒ»ãªãœé‡è¦ã‹ã‚’å…·ä½“çš„ã«2è¡Œã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚å›ºæœ‰åè©ã‚„æ•°å­—ã¯çœç•¥ã—ãªã„ã§ãã ã•ã„ã€‚"},
                {role: "user", content: $content}
              ]
            }' | curl -s https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d @- | jq -r '.choices[0].message.content'
          }

          NHK_SUMMARY=$(summarize "$NHK_INPUT")
          IT_SUMMARY=$(summarize "$IT_INPUT")
          BUZZ_SUMMARY=$(summarize "$BUZZ_INPUT")

          echo "NHK_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$NHK_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "IT_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$IT_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "BUZZ_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$BUZZ_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- Send to Discord ---

      - name: Send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CONTENT=$(printf 'ğŸ“° **ä»Šæ—¥ã®AIè¦ç´„ãƒ‹ãƒ¥ãƒ¼ã‚¹**\n\nğŸŒ **ã€æœ€é‡è¦ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘**\n%s\n\nğŸ’» **ã€AIãƒ»ãƒ†ãƒƒã‚¯ã€‘**\n%s\n\nğŸ”§ **ã€ITç·åˆã€‘**\n%s' "$NHK_SUMMARY" "$IT_SUMMARY" "$BUZZ_SUMMARY")

          jq -n --arg content "$CONTENT" '{content: $content}' | curl -s \
            -H "Content-Type: application/json" \
            -X POST \
            -d @- \
            "$WEBHOOK"