name: Daily AI News

on:
  schedule:
    - cron: "0 22 * * *"  # JST 7:00
  workflow_dispatch:

jobs:
  news:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq libxml2-utils

      # --- Fetch RSS ---

      - name: Fetch NHK Top 3 News
        run: |
          HTTP_CODE=$(curl -s -o nhk.xml -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://www3.nhk.or.jp/rss/news/cat0.xml)

          if [ "$HTTP_CODE" -ne 200 ] || ! xmllint --noout nhk.xml 2>/dev/null; then
            echo "NHK RSSã®å–å¾—ã«å¤±æ•—ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™..."
            echo "NHK1_INPUT=NHKè¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            echo "NHK2_INPUT=NHKè¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            echo "NHK3_INPUT=NHKè¨˜äº‹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            exit 0
          fi

          for i in 1 2 3; do
            TITLE=$(xmllint --xpath "string(//item[$i]/title)" nhk.xml 2>/dev/null || echo "")
            DESC=$(xmllint --xpath "string(//item[$i]/description)" nhk.xml 2>/dev/null || echo "")
            if [ -z "$TITLE" ]; then
              echo "NHK${i}_INPUT=NHKè¨˜äº‹${i}ä»¶ç›®ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_ENV
            else
              echo "NHK${i}_INPUT<<EOF" >> $GITHUB_ENV
              echo "ã€${TITLE}ã€‘${DESC}" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          done

      # --- AI Summary ---

      - name: Summarize with AI
        env:
          API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          summarize() {
            jq -n --arg content "$1" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¦‚è¦ã‹ã‚‰ã€ä½•ãŒèµ·ããŸã‹ãƒ»ãªãœé‡è¦ã‹ã‚’å…·ä½“çš„ã«2è¡Œã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚å›ºæœ‰åè©ã‚„æ•°å­—ã¯çœç•¥ã—ãªã„ã§ãã ã•ã„ã€‚"},
                {role: "user", content: $content}
              ]
            }' | curl -s https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d @- | jq -r '.choices[0].message.content'
          }

          NHK1_SUMMARY=$(summarize "$NHK1_INPUT")
          NHK2_SUMMARY=$(summarize "$NHK2_INPUT")
          NHK3_SUMMARY=$(summarize "$NHK3_INPUT")

          echo "NHK1_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$NHK1_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "NHK2_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$NHK2_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "NHK3_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$NHK3_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- Send to Discord ---

      - name: Send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CONTENT=$(printf 'ğŸ“° **ä»Šæ—¥ã®AIè¦ç´„ãƒ‹ãƒ¥ãƒ¼ã‚¹**\n\nğŸŒ **ã€é‡å¤§ãƒ‹ãƒ¥ãƒ¼ã‚¹â‘ ã€‘**\n%s\n\nğŸŒ **ã€é‡å¤§ãƒ‹ãƒ¥ãƒ¼ã‚¹â‘¡ã€‘**\n%s\n\nğŸŒ **ã€é‡å¤§ãƒ‹ãƒ¥ãƒ¼ã‚¹â‘¢ã€‘**\n%s' "$NHK1_SUMMARY" "$NHK2_SUMMARY" "$NHK3_SUMMARY")

          jq -n --arg content "$CONTENT" '{content: $content}' | curl -s \
            -H "Content-Type: application/json" \
            -X POST \
            -d @- \
            "$WEBHOOK"