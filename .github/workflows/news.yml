name: Daily AI News

on:
  schedule:
    - cron: "0 22 * * *"  # JST 7:00
  workflow_dispatch:

jobs:
  news:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq xmlstarlet libxml2-utils

      # --- Fetch RSS ---

      - name: Fetch NHK Top News
        run: |
          curl -s https://www3.nhk.or.jp/rss/news/cat0.xml -o nhk.xml
          NHK_DESC=$(xmllint --xpath "string(//item[1]/description)" nhk.xml)
          echo "NHK_DESC<<EOF" >> $GITHUB_ENV
          echo "$NHK_DESC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch ITmedia News
        run: |
          curl -s https://www.itmedia.co.jp/news/subtop/rss2/0.xml -o it.xml
          IT_DESC=$(xmllint --xpath "string(//item[1]/description)" it.xml)
          echo "IT_DESC<<EOF" >> $GITHUB_ENV
          echo "$IT_DESC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch Gigazine Tech
        run: |
          curl -s https://gigazine.net/news/rss_2.0/ -o giga.xml
          GIGA_DESC=$(xmllint --xpath "string(//item[1]/description)" giga.xml)
          echo "GIGA_DESC<<EOF" >> $GITHUB_ENV
          echo "$GIGA_DESC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- AI Summary ---

      - name: Summarize with AI
        env:
          API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          summarize() {
            jq -n --arg content "$1" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "„Éã„É•„Éº„Çπ„Çí2Ë°å„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"},
                {role: "user", content: $content}
              ]
            }' | curl -s https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d @- | jq -r '.choices[0].message.content'
          }

          NHK_SUMMARY=$(summarize "$NHK_DESC")
          IT_SUMMARY=$(summarize "$IT_DESC")
          GIGA_SUMMARY=$(summarize "$GIGA_DESC")

          echo "NHK_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$NHK_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "IT_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$IT_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "GIGA_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$GIGA_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- Send to Discord ---

      - name: Send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CONTENT="üì∞ **‰ªäÊó•„ÅÆAIË¶ÅÁ¥Ñ„Éã„É•„Éº„Çπ**\n\n\
**„ÄêÊúÄÈáçË¶Å„Éã„É•„Éº„Çπ„Äë**\n$NHK_SUMMARY\n\n\
**„ÄêIT„Éã„É•„Éº„Çπ„Äë**\n$IT_SUMMARY\n\n\
**„ÄêAI„ÉªÈù¢ÁôΩ„ÉÜ„ÉÉ„ÇØ„Äë**\n$GIGA_SUMMARY"

          jq -n --arg content "$CONTENT" '{content: $content}' | curl -s \
            -H "Content-Type: application/json" \
            -X POST \
            -d @- \
            "$WEBHOOK"
