name: Daily AI News

on:
  schedule:
    - cron: "0 22 * * *"  # UTC 22:00 = JST 07:00
  workflow_dispatch:

jobs:
  news:
    runs-on: ubuntu-latest

    steps:
      # Install xmllint (libxml2-utils) and jq for RSS parsing and JSON handling
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq libxml2-utils

      # --- Fetch RSS ---

      # Fetch the top NHK news item description and store it as a multi-line env var
      - name: Fetch NHK Top News
        run: |
          curl -s https://www3.nhk.or.jp/rss/news/cat0.xml -o nhk.xml
          NHK_DESC=$(xmllint --xpath "string(//item[1]/description)" nhk.xml)
          {
            echo "NHK_DESC<<EOF"
            echo "$NHK_DESC"
            echo "EOF"
          } >> "$GITHUB_ENV"

      # Fetch the top ITmedia news item description
      - name: Fetch ITmedia News
        run: |
          curl -s https://www.itmedia.co.jp/news/subtop/rss2/0.xml -o it.xml
          IT_DESC=$(xmllint --xpath "string(//item[1]/description)" it.xml)
          {
            echo "IT_DESC<<EOF"
            echo "$IT_DESC"
            echo "EOF"
          } >> "$GITHUB_ENV"

      # Fetch the top Gigazine tech article description
      - name: Fetch Gigazine Tech
        run: |
          curl -s https://gigazine.net/news/rss_2.0/ -o giga.xml
          GIGA_DESC=$(xmllint --xpath "string(//item[1]/description)" giga.xml)
          {
            echo "GIGA_DESC<<EOF"
            echo "$GIGA_DESC"
            echo "EOF"
          } >> "$GITHUB_ENV"

      # --- AI Summary ---

      # Call GitHub Models (gpt-4o-mini) to summarize each article in 2 lines
      - name: Summarize with AI
        env:
          API_KEY: ${{ secrets.COPILOT_API_KEY }}
        run: |
          summarize() {
            jq -n --arg content "$1" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "„Éã„É•„Éº„Çπ„Çí2Ë°å„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"},
                {role: "user", content: $content}
              ]
            }' | curl -s https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d @- | jq -r '.choices[0].message.content'
          }

          NHK_SUMMARY=$(summarize "$NHK_DESC")
          IT_SUMMARY=$(summarize "$IT_DESC")
          GIGA_SUMMARY=$(summarize "$GIGA_DESC")

          # Use heredoc format to safely write multi-line summaries to GITHUB_ENV
          {
            echo "NHK_SUMMARY<<EOF"
            echo "$NHK_SUMMARY"
            echo "EOF"
          } >> "$GITHUB_ENV"
          {
            echo "IT_SUMMARY<<EOF"
            echo "$IT_SUMMARY"
            echo "EOF"
          } >> "$GITHUB_ENV"
          {
            echo "GIGA_SUMMARY<<EOF"
            echo "$GIGA_SUMMARY"
            echo "EOF"
          } >> "$GITHUB_ENV"

      # --- Send to Discord ---

      # Build the Discord message and POST it via webhook; jq handles JSON escaping
      - name: Send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CONTENT="$(printf 'üì∞ **‰ªäÊó•„ÅÆAIË¶ÅÁ¥Ñ„Éã„É•„Éº„Çπ**\n\n**„ÄêÊúÄÈáçË¶Å„Éã„É•„Éº„Çπ„Äë**\n%s\n\n**„ÄêIT„Éã„É•„Éº„Çπ„Äë**\n%s\n\n**„ÄêAI„ÉªÈù¢ÁôΩ„ÉÜ„ÉÉ„ÇØ„Äë**\n%s' \
            "$NHK_SUMMARY" "$IT_SUMMARY" "$GIGA_SUMMARY")"

          jq -n --arg content "$CONTENT" '{content: $content}' | curl -s \
            -H "Content-Type: application/json" \
            -X POST \
            -d @- \
            "$WEBHOOK"
